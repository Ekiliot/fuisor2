# üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è Reply —Ñ—É–Ω–∫—Ü–∏–∏

## üéØ –ß—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —ç—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è

–î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö:
- –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ `reply_to_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `messages`
- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
- Foreign key constraint —Å `ON DELETE SET NULL`

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Supabase Dashboard](https://app.supabase.com)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –û—Ç–∫—Ä–æ–π—Ç–µ **SQL Editor** (–∏–∫–æ–Ω–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–ª–µ–≤–∞)
4. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `add_reply_to_messages.sql`:

```sql
-- Add support for reply to messages
-- Add reply_to_id column to messages table

ALTER TABLE messages
ADD COLUMN IF NOT EXISTS reply_to_id UUID REFERENCES messages(id) ON DELETE SET NULL;

-- Create index for faster reply lookups
CREATE INDEX IF NOT EXISTS idx_messages_reply_to_id ON messages(reply_to_id) WHERE reply_to_id IS NOT NULL;

COMMENT ON COLUMN messages.reply_to_id IS 'ID of the message this message is replying to';
```

5. –ù–∞–∂–º–∏—Ç–µ **Run** (–∏–ª–∏ Ctrl/Cmd + Enter)
6. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ (–¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è "Success")

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Supabase CLI

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/fuisorbk

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
supabase db push

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ psql
psql "$DATABASE_URL" < supabase/migrations/add_reply_to_messages.sql
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'messages' AND column_name = 'reply_to_id';

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'messages' AND indexname = 'idx_messages_reply_to_id';
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –ö–æ–ª–æ–Ω–∫–∞ `reply_to_id` —Ç–∏–ø–∞ `uuid`, nullable = YES
- –ò–Ω–¥–µ–∫—Å `idx_messages_reply_to_id` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

## üîÑ –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:

```sql
-- –£–¥–∞–ª—è–µ–º –∏–Ω–¥–µ–∫—Å
DROP INDEX IF EXISTS idx_messages_reply_to_id;

-- –£–¥–∞–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É
ALTER TABLE messages DROP COLUMN IF EXISTS reply_to_id;
```

## üì± –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±—ç–∫–µ–Ω–¥ —Å–µ—Ä–≤–µ—Ä:
```bash
npm run dev
```

2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é reply:
   - –°–≤–∞–π–ø–Ω–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤–ø—Ä–∞–≤–æ –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö, –≤–ª–µ–≤–æ –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö)
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ‚Üí "Reply"
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä reply —Å –ø—Ä–µ–≤—å—é —Å–æ–æ–±—â–µ–Ω–∏—è
   - –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä ‚Äî –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å—Å—è –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é

## üêõ Troubleshooting

**–ü—Ä–æ–±–ª–µ–º–∞:** "ERROR: relation "messages" does not exist"
**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±—ã–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å–º. `MIGRATION_ORDER.md`)

**–ü—Ä–æ–±–ª–µ–º–∞:** "ERROR: column "reply_to_id" of relation "messages" already exists"
**–†–µ—à–µ–Ω–∏–µ:** –ú–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ –±—ã–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞. –ú–æ–∂–Ω–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É –æ—à–∏–±–∫—É.

**–ü—Ä–æ–±–ª–µ–º–∞:** Reply –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ `reply_to_id` –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ë–î
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞ ‚Äî –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å `replyToId` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω (–¥–æ–±–∞–≤–ª–µ–Ω `reply_to_id` –≤ messageData)

