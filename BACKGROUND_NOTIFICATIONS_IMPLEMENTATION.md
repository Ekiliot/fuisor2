# Реализация фоновых уведомлений

## Что было реализовано

### 1. ✅ Запрос разрешений на уведомления после входа

После успешного входа в аккаунт приложение автоматически запрашивает разрешение на уведомления. Это происходит в `AuthWrapper` после того, как пользователь успешно авторизован.

### 2. ✅ Фоновый сервис для проверки новых событий

Реализован фоновый сервис на базе `workmanager`, который:
- Периодически проверяет новые события каждые 15 минут
- Работает даже когда приложение закрыто
- Запрашивает API эндпоинт `/api/notifications/check`
- Показывает локальные уведомления при обнаружении новых событий

### 3. ✅ Настройка Android манифеста

Добавлены необходимые разрешения:
- `POST_NOTIFICATIONS` - для показа уведомлений
- `WAKE_LOCK` - для работы в фоне
- `RECEIVE_BOOT_COMPLETED` - для автоматического перезапуска после перезагрузки устройства

## Структура файлов

### Новые файлы:

1. **`fuisor_app/lib/services/notification_service.dart`**
   - Управление локальными уведомлениями
   - Запрос разрешений
   - Показ уведомлений

2. **`fuisor_app/lib/services/background_notification_service.dart`**
   - Фоновый сервис с Workmanager
   - Периодическая проверка новых событий
   - Обработка и показ уведомлений

### Изменённые файлы:

1. **`fuisor_app/pubspec.yaml`**
   - Добавлены пакеты:
     - `flutter_local_notifications: ^18.0.1`
     - `workmanager: ^0.5.2`

2. **`fuisor_app/lib/main.dart`**
   - Инициализация сервисов уведомлений
   - Запрос разрешений после входа
   - Запуск/остановка фонового сервиса

3. **`fuisor_app/android/app/src/main/AndroidManifest.xml`**
   - Разрешения для уведомлений и фоновых задач
   - Receivers для Workmanager

## Как это работает

### После входа в аккаунт:

1. Приложение проверяет, есть ли разрешение на уведомления
2. Если разрешения нет - запрашивает его
3. После получения разрешения запускает фоновый сервис
4. Фоновый сервис начинает периодически проверять новые события

### Фоновая проверка:

1. Каждые 15 минут Workmanager вызывает callback
2. Callback получает access token из SharedPreferences
3. Делает запрос к `/api/notifications/check`
4. Обрабатывает ответ и показывает уведомления для:
   - Новых уведомлений (лайки, комментарии, подписки)
   - Непрочитанных сообщений
   - Новых постов от подписок
   - Новых stories от подписок

### При выходе:

1. Останавливается heartbeat (онлайн статус)
2. Останавливается фоновый сервис
3. Отменяются все запланированные проверки

## Типы уведомлений

### 1. Уведомления (notifications)
- Лайки на посты
- Комментарии
- Подписки
- Упоминания

### 2. Сообщения (messages)
- Непрочитанные сообщения в чатах
- Показывает имя отправителя и текст сообщения

### 3. Новые посты (posts)
- Новые посты от пользователей из подписок

### 4. Новые stories
- Новые stories от пользователей из подписок

## Настройка интервала проверки

Интервал проверки можно изменить в `background_notification_service.dart`:

```dart
await Workmanager().registerPeriodicTask(
  _taskName,
  _taskName,
  frequency: const Duration(minutes: 15), // Изменить здесь
  constraints: Constraints(
    networkType: NetworkType.connected,
  ),
);
```

**Важно:** Минимальный интервал для периодических задач в Android - 15 минут. Для более частых проверок нужно использовать другой подход (например, FCM push-уведомления).

## Отладка

Для проверки работы фонового сервиса:

1. **Проверка разрешений:**
   ```dart
   final service = NotificationService();
   final hasPermission = await service.checkPermission();
   print('Has permission: $hasPermission');
   ```

2. **Ручной запуск проверки:**
   ```dart
   final bgService = BackgroundNotificationService();
   await bgService.checkForNewEvents();
   ```

3. **Проверка логов:**
   - Все логи имеют префикс `[Notifications Check]` или `BackgroundNotificationService:`
   - Проверьте логи в Android Studio или через `adb logcat`

## Известные ограничения

1. **Минимальный интервал:** Android ограничивает периодические задачи до 15 минут минимум
2. **Батарея:** Android может ограничивать работу в фоне для экономии батареи
3. **Оптимизация батареи:** Пользователи могут отключить фоновую работу в настройках системы

## Следующие шаги (опционально)

1. **FCM Push Notifications:** Для мгновенных уведомлений можно интегрировать Firebase Cloud Messaging
2. **iOS поддержка:** Настроить Background Modes для iOS
3. **Навигация:** Реализовать обработку нажатий на уведомления для навигации в приложении
4. **Настройки:** Добавить настройку интервала проверки в UI

## Команды для установки

После добавления новых пакетов выполните:

```bash
cd fuisor_app
flutter pub get
flutter clean
flutter run
```

## Проверка работы

1. Войдите в аккаунт
2. Разрешите уведомления
3. Закройте приложение
4. Подождите 15 минут (или измените интервал на меньшее для теста)
5. Проверьте, пришло ли уведомление
6. Проверьте в списке открытых приложений - приложение должно там отображаться

## Решение проблем

### Приложение не появляется в списке открытых приложений:

1. Проверьте, что фоновый сервис запущен:
   ```dart
   await BackgroundNotificationService.startPeriodicCheck();
   ```

2. Проверьте логи на наличие ошибок

3. Убедитесь, что разрешения предоставлены

### Уведомления не приходят:

1. Проверьте разрешения в настройках приложения
2. Проверьте логи на ошибки API запросов
3. Убедитесь, что access token валидный
4. Проверьте работу API эндпоинта `/api/notifications/check`

### Фоновый сервис не работает:

1. Проверьте, что Workmanager инициализирован в `main()`
2. Убедитесь, что разрешения в AndroidManifest.xml добавлены
3. Проверьте логи на ошибки инициализации

