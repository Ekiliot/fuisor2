# Настройка отправки email для OTP кодов

## Проблема

Сейчас OTP коды выводятся в логи сервера вместо отправки на email, потому что email-сервис не настроен.

## Решение

Интегрирован сервис отправки email через **Resend API**. Если Resend не настроен, OTP коды будут логироваться в консоль (как сейчас).

## Вариант 1: Использование Resend (Рекомендуется)

### Шаги настройки:

1. **Зарегистрируйтесь на Resend:**
   - Перейдите на [https://resend.com](https://resend.com)
   - Создайте аккаунт (есть бесплатный план - 100 email/день)

2. **Получите API ключ:**
   - После регистрации перейдите в Dashboard
   - Создайте новый API ключ
   - Скопируйте ключ (начинается с `re_...`)

3. **Настройте домен (для продакшена):**
   - В Resend Dashboard добавьте ваш домен
   - Настройте DNS записи (SPF, DKIM, DMARC)
   - Для разработки можно использовать домен `onboarding.resend.dev`

4. **Добавьте переменные окружения:**

   В файл `.env` (или в настройки вашего хостинга, например Vercel):

   ```env
   RESEND_API_KEY=re_your_api_key_here
   RESEND_FROM_EMAIL=SONET <noreply@yourdomain.com>
   ```

   **Что означает `RESEND_FROM_EMAIL`?**
   
   Это адрес отправителя email. Формат: `"Имя <email@домен.com>"`
   - `SONET` — имя отправителя (будет видно в почте)
   - `noreply@yourdomain.com` — email адрес отправителя
   
   **Варианты:**
   
   1. **Для разработки (можно использовать сразу без настройки):**
      ```env
      RESEND_FROM_EMAIL=SONET <onboarding@resend.dev>
      ```
      Это тестовый домен Resend, работает сразу.
   
   2. **Для продакшена (нужен свой домен):**
      ```env
      RESEND_FROM_EMAIL=SONET <noreply@fuisor2.vercel.app>
      ```
      Или если у вас свой домен:
      ```env
      RESEND_FROM_EMAIL=SONET <noreply@yourdomain.com>
      ```
      
      **Важно:** Для продакшена нужно:
      - Добавить домен в Resend Dashboard
      - Настроить DNS записи (SPF, DKIM)
      - Дождаться верификации домена

5. **Перезапустите сервер:**
   ```bash
   npm restart
   # или
   pm2 restart all
   ```

### Проверка работы:

После настройки, при запросе OTP:
- Email будет отправлен на указанный адрес
- OTP код будет виден в письме (красивый HTML шаблон)
- В логах будет сообщение: `[EMAIL] OTP sent successfully to ...`

## Вариант 2: Использование другого email-сервиса

Вы можете модифицировать `src/utils/email_service.js` для использования других сервисов:

- **SendGrid** - популярный email-сервис
- **AWS SES** - для AWS инфраструктуры
- **Mailgun** - еще один популярный вариант
- **Nodemailer** - для SMTP отправки

### Пример для SendGrid:

```javascript
import sgMail from '@sendgrid/mail';

sgMail.setApiKey(process.env.SENDGRID_API_KEY);

const msg = {
  to: email,
  from: process.env.SENDGRID_FROM_EMAIL,
  subject: 'Your Password Change Verification Code - SONET',
  html: htmlContent,
};

await sgMail.send(msg);
```

## Вариант 3: Использование Supabase Edge Functions

Можно создать Supabase Edge Function для отправки email. Подробнее: [Supabase Edge Functions](https://supabase.com/docs/guides/functions)

## Текущее поведение (без настройки)

Если `RESEND_API_KEY` не установлен:
- OTP коды выводятся в логи сервера
- В консоли будет сообщение: `[EMAIL] OTP Code for user@example.com: 123456`
- Email не отправляется
- Пользователь может получить OTP только через логи

## Шаблоны email

HTML шаблоны находятся в папке `src/templates/`:

- **`password_change_otp.html`** - для смены пароля (авторизованный пользователь)
- **`password_reset_otp.html`** - для восстановления пароля (неавторизованный пользователь)

Шаблоны используют темную тему в стиле SONET и включают:
- Современный дизайн с иконками
- Красиво оформленный OTP код
- Адаптивный дизайн для мобильных устройств
- Информацию о сроке действия (10 минут)
- Предупреждение о безопасности
- Футер с ссылками на помощь

**Особенности дизайна:**
- Совместимость с основными почтовыми клиентами (Gmail, Outlook, Apple Mail и др.)
- Использование таблиц для максимальной совместимости
- Inline CSS стили
- Поддержка темной темы
- Адаптивность для мобильных устройств

## Устранение неполадок

### Email не отправляются:

1. **Проверьте API ключ:**
   - Убедитесь, что `RESEND_API_KEY` установлен правильно
   - Проверьте, что ключ активен в Resend Dashboard

2. **Проверьте адрес отправителя:**
   - Для продакшена: используйте верифицированный домен
   - Для разработки: используйте `onboarding@resend.dev`

3. **Проверьте логи:**
   - Ищите сообщения с префиксом `[EMAIL]`
   - Проверьте наличие ошибок

4. **Проверьте спам:**
   - Email может попасть в спам
   - Проверьте папку "Спам" в почтовом ящике

### OTP код не приходит:

- Проверьте логи сервера - там будет OTP код
- Убедитесь, что email адрес пользователя правильный
- Проверьте, что email-сервис настроен

## Для разработки

В режиме разработки (`NODE_ENV=development`) OTP коды всегда логируются в консоль, даже если email отправлен успешно. Это помогает тестировать функциональность без необходимости проверять почту.

